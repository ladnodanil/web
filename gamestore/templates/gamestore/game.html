{% extends 'base.html' %} {% load static %} {% block content %}
<div class="game-detail">
  {% if perms.women.change_women %}
  <div class="edit-link">
    <a href="{% url 'edit_game' game.id %}" class="button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
  </div>
  {% endif %}
  
  <h1 class="game-title">{{ game.title }}</h1>
  
  <div class="game-actions">
    {% if user.is_authenticated %}
    <form method="post" action="{% url 'like_game' game.slug %}" style="display: inline">
      {% csrf_token %}
      <button type="submit" class="like-button {% if user_liked %}liked{% endif %}">
        {% if user_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %} <span class="likes-count">{{ likes_count }}</span>
      </button>
    </form>
    {% else %}
    <div class="like-button disabled">
      ü§ç <span class="likes-count">{{ likes_count }}</span>
    </div>
    {% endif %}
  </div>

  <div class="game-info">
    {% if game.image %}
    <div class="game-image">
      <img src="{{ game.image.url }}" alt="{{ game.title }}" />
    </div>
    {% endif %}
    
    <div class="game-content">
      <div class="game-description">
        <h2>–û–ø–∏—Å–∞–Ω–∏–µ</h2>
        <p>{{ game.description|linebreaks }}</p>
      </div>

      <div class="game-details">
        <h2>–î–µ—Ç–∞–ª–∏ –∏–≥—Ä—ã</h2>
        <div class="details-grid">
          <p><strong>–¶–µ–Ω–∞:</strong> <span class="price">{{ game.price }} —Ä—É–±.</span></p>
          <p>
            <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong>
            <a href="{{ game.category.get_absolute_url }}">{{ game.category.name }}</a>
          </p>
          <p>
            <strong>–¢–µ–≥–∏:</strong>
            <div class="tags">
              {% for tag in game.tags.all %}
              <a href="{{ tag.get_absolute_url }}" class="tag">{{ tag.name }}</a>
              {% endfor %}
            </div>
          </p>
          {% if game.details %}
          <p><strong>–î–∞—Ç–∞ –≤—ã–ø—É—Å–∫–∞:</strong> {{ game.details.release_date }}</p>
          <p><strong>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</strong> {{ game.details.developer }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<div class="comments-section">
  <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>

  {% if user.is_authenticated %}
  <div class="add-comment">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
    <form method="post" action="{% url 'add_comment' game_slug=game.slug %}" class="comment-form">
      {% csrf_token %}
      {{ comment_form.as_p }}
      <button type="submit" class="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>
  {% else %}
  <p>–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'users:login' %}">–≤–æ–π–¥–∏—Ç–µ</a> –≤ —Å–∏—Å—Ç–µ–º—É.</p>
  {% endif %}

  <div class="comments-list">
    {% for comment in comments %}
    <div class="comment">
      <div class="comment-header">
        <strong>{{ comment.user.username }}</strong>
        <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
        {% if comment.user == user %}
        <div class="comment-actions">
          <button class="button-m edit-comment" data-comment-id="{{ comment.id }}">‚úé</button>
          <form method="post" action="{% url 'delete_comment' comment_id=comment.id %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="button-m" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')">‚úï</button>
          </form>
        </div>
        {% endif %}
      </div>
      <div class="comment-text" id="comment-text-{{ comment.id }}">{{ comment.text|linebreaks }}</div>
      {% if comment.user == user %}
      <div class="comment-edit-form" id="comment-edit-{{ comment.id }}" style="display: none;">
        <form method="post" action="{% url 'edit_comment' comment_id=comment.id %}" class="edit-form">
          {% csrf_token %}
          <textarea name="text" rows="4" class="edit-textarea">{{ comment.text }}</textarea>
          <div class="edit-actions">
            <button type="submit" class="button save-edit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" class="button cancel-edit">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
      {% endif %}
    </div>
    {% empty %}
    <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
    {% endfor %}
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Edit button click handler
    document.querySelectorAll('.edit-comment').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            document.getElementById(`comment-text-${commentId}`).style.display = 'none';
            document.getElementById(`comment-edit-${commentId}`).style.display = 'block';
        });
    });

    // Cancel button click handler
    document.querySelectorAll('.cancel-edit').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.closest('.comment-edit-form').id.split('-')[2];
            document.getElementById(`comment-text-${commentId}`).style.display = 'block';
            document.getElementById(`comment-edit-${commentId}`).style.display = 'none';
        });
    });

    // Form submit handler
    document.querySelectorAll('.edit-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const commentId = this.closest('.comment-edit-form').id.split('-')[2];

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById(`comment-text-${commentId}`).innerHTML = data.text.replace(/\n/g, '<br>');
                    document.getElementById(`comment-text-${commentId}`).style.display = 'block';
                    document.getElementById(`comment-edit-${commentId}`).style.display = 'none';
                } else {
                    throw new Error('Server returned error status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            });
        });
    });
});
</script>
{% endblock %}

